plugins {
    id 'java'
    id 'distribution'
    id "org.hidetake.ssh" version "1.1.3"
}

//noinspection GroovyUnusedAssignment
sourceCompatibility = 1.8
//noinspection GroovyUnusedAssignment
targetCompatibility = 1.8

repositories {
    jcenter()
}

dependencies {
    compile group: 'com.google.guava', name: 'guava', version: '18.0'
    compile 'commons-cli:commons-cli:1.3'
    compile 'org.apache.commons:commons-lang3:3.4'
    compile 'org.apache.commons:commons-math3:3.5'
    testCompile 'org.mockito:mockito-core:2.0.2-beta'
    testCompile 'org.testng:testng:6.9.4'
}

sourceSets {
    main {
        java {
            srcDir 'src/java'
        }
    }
    test {
        java {
            srcDir 'test/java'
        }
        resources {
            srcDir 'test/resources'
        }
    }
}

test.doFirst {
    useTestNG()
}

wrapper.gradleVersion = '2.4'

@SuppressWarnings("GroovyAssignabilityCheck")
CreateStartScripts buildStartScript(String appName, String mainClass) {
    task "${appName}StartScript"(type: CreateStartScripts) {
        mainClassName = mainClass
        applicationName = appName
        outputDir = new File(project.buildDir, 'scripts');
        classpath = jar.outputs.files + project.configurations.runtime
        group = "scripts"
    }
}

@SuppressWarnings("GroovyAssignabilityCheck")
CreateStartScripts buildStartScript(String appName, String mainClass, Iterable<String> jvmOpts) {
    task "${appName}StartScript"(type: CreateStartScripts) {
        mainClassName = mainClass
        applicationName = appName
        defaultJvmOpts = jvmOpts
        outputDir = new File(project.buildDir, 'scripts');
        classpath = jar.outputs.files + project.configurations.runtime
        group = "scripts"
    }
}

task addAllStartSctipts(dependsOn: jar) {
    group = "scripts"
    def cpmrJVM = ["-Xms4g", "-Xms10g"]
    def detectJVM = ["-Xms2g", "-Xms4g"]
    buildStartScript("cpmr", "edu.cwru.cbc.ASM.CPMR.CPMR_Pgm", cpmrJVM).execute()
    buildStartScript("detect", "edu.cwru.cbc.ASM.detect.DetectionPgm", detectJVM).execute()
    buildStartScript("convert", "edu.cwru.cbc.ASM.tools.conversion.FormatConversionPgm").execute()
    buildStartScript("intersect", "edu.cwru.cbc.ASM.tools.IntersectRegionsPgm").execute()
    buildStartScript("simulate", "edu.cwru.cbc.ASM.tools.simulation.SimulationPgm").execute()
    buildStartScript("visualize", "edu.cwru.cbc.ASM.tools.ReadsVisualizationPgm").execute()
}

distributions {
    //noinspection GroovyAssignabilityCheck
    main {
        contents {
            addAllStartSctipts
            into('bin') {
                from 'build/scripts'
            }
            into('lib') {
                from 'build/libs'
                from configurations.runtime
            }

            exclude "**/*.bat"
        }
    }
}

remotes {
    lab {
        host = 'lancelothk.case.edu'
        user = 'kehu'
        identity = file('/home/lancelothk/.ssh/id_rsa')
    }
}

task updateBin(dependsOn: installDist) {
    doLast {
        if (jar.state.skipped == false) {
            def userName = System.getProperty('user.name')
            if (userName == "kehu") {
                copy {
                    from 'build/install/ASM/bin'
                    into '/home/kehu/experiments/ASM/bin'
                }
                copy {
                    from 'build/libs/ASM.jar'
                    into '/home/kehu/experiments/ASM/lib'
                }
            } else if (userName == "lancelothk") {
                ssh.run {
                    session(remotes.lab) {
                        put from: buildDir.toString() + '/install/ASM/bin', into: 'experiments/ASM'
                        put from: buildDir.toString() + '/libs/ASM.jar', into: 'experiments/ASM/lib'
                    }
                }
            }
        }
    }
}

task updateInstall(dependsOn: installDist) {
    doLast {
        if (installDist.state.skipped == false) {
            def userName = System.getProperty('user.name')
            if (userName == "kehu") {
                copy {
                    from 'build/install/ASM/bin'
                    into '/home/kehu/experiments/ASM/bin'
                }
                copy {
                    from 'build/install/ASM/lib'
                    into '/home/kehu/experiments/ASM/lib'
                }
            } else if (userName == "lancelothk") {
                ssh.run {
                    session(remotes.lab) {
                        put from: buildDir.toString() + '/install/ASM/bin', into: 'experiments/ASM'
                        put from: buildDir.toString() + '/install/ASM/lib', into: 'experiments/ASM'
                    }
                }
            }
        }
    }
}

installDist.dependsOn build